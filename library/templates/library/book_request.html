{% extends 'library/base.html' %}

{% block content %}
<div class="container mt-4">
    <h1>Request Buku Baru</h1>
    <p>Silakan isi data request buku Anda. Pilih tipe request untuk menampilkan field yang relevan.</p>

    <!-- Pesan sukses/error -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Form di atas -->
    <form method="post">
        {% csrf_token %}
        <div class="mb-3">
            <label for="{{ form.request_type.id_for_label }}" class="form-label">{{ form.request_type.label }}</label>
            {{ form.request_type }}
            {% if form.request_type.errors %}<div class="text-danger">{{ form.request_type.errors }}</div>{% endif %}
        </div>
        
        <!-- Field untuk Murid -->
        <div id="student_fields" style="display: none;">
            <h3>Detail untuk Murid</h3>
            <div class="mb-3">
                <label for="{{ form.student_name.id_for_label }}" class="form-label">{{ form.student_name.label }}</label>
                <input type="text" name="{{ form.student_name.name }}" class="form-control" id="{{ form.student_name.id_for_label }}" value="{{ form.student_name.value|default:'' }}">
                {% if form.student_name.errors %}<div class="text-danger">{{ form.student_name.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.class_name.id_for_label }}" class="form-label">{{ form.class_name.label }}</label>
                <input type="text" name="{{ form.class_name.name }}" class="form-control" id="{{ form.class_name.id_for_label }}" value="{{ form.class_name.value|default:'' }}">
                {% if form.class_name.errors %}<div class="text-danger">{{ form.class_name.errors }}</div>{% endif %}
            </div>
        </div>
        
        <!-- Field untuk Orang Tua -->
        <div id="parent_fields" style="display: none;">
            <h3>Detail untuk Orang Tua</h3>
            <div class="mb-3">
                <label for="{{ form.parent_name.id_for_label }}" class="form-label">{{ form.parent_name.label }}</label>
                <input type="text" name="{{ form.parent_name.name }}" class="form-control" id="{{ form.parent_name.id_for_label }}" value="{{ form.parent_name.value|default:'' }}">
                {% if form.parent_name.errors %}<div class="text-danger">{{ form.parent_name.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.child_name.id_for_label }}" class="form-label">{{ form.child_name.label }}</label>
                <input type="text" name="{{ form.child_name.name }}" class="form-control" id="{{ form.child_name.id_for_label }}" value="{{ form.child_name.value|default:'' }}">
                {% if form.child_name.errors %}<div class="text-danger">{{ form.child_name.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
                <label for="{{ form.child_class.id_for_label }}" class="form-label">{{ form.child_class.label }}</label>
                <input type="text" name="{{ form.child_class.name }}" class="form-control" id="{{ form.child_class.id_for_label }}" value="{{ form.child_class.value|default:'' }}">
                {% if form.child_class.errors %}<div class="text-danger">{{ form.child_class.errors }}</div>{% endif %}
            </div>
        </div>
        
        <!-- Field umum -->
        <div class="mb-3">
            <label for="{{ form.book_title_or_type.id_for_label }}" class="form-label">{{ form.book_title_or_type.label }}</label>
            <input type="text" name="{{ form.book_title_or_type.name }}" class="form-control" id="{{ form.book_title_or_type.id_for_label }}" value="{{ form.book_title_or_type.value|default:'' }}" placeholder="Contoh: 'Harry Potter' atau 'Buku Matematika'">
            {% if form.book_title_or_type.errors %}<div class="text-danger">{{ form.book_title_or_type.errors }}</div>{% endif %}
        </div>
        
        <button type="submit" class="btn btn-primary">Kirim Request</button>
        <a href="{% url 'home' %}" class="btn btn-secondary">Batal</a>
    </form>

    <!-- Tabel hasil di bawah -->
    <div class="mt-5">
        <h2>Daftar Request Buku</h2>
        {% if all_requests %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Tipe Request</th>
                        <th>Detail</th>
                        <th>Judul/Jenis Buku</th>
                        <th>Waktu Submit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in all_requests %}
                        <tr>
                            <td>{{ request.get_request_type_display }}</td>
                            <td>
                                {% if request.request_type == 'student' %}
                                    Murid: {{ request.student_name }} (Kelas {{ request.class_name }})
                                {% elif request.request_type == 'parent' %}
                                    Orang Tua: {{ request.parent_name }} (Anak: {{ request.child_name }}, Kelas {{ request.child_class }})
                                {% endif %}
                            </td>
                            <td>{{ request.book_title_or_type }}</td>
                            <td>{{ request.submitted_at|date:"d M Y, H:i" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-muted">Belum ada request buku.</p>
        {% endif %}
    </div>

    <!-- JavaScript sederhana untuk toggle -->
    <script>
        function toggleFields() {
            const requestType = document.getElementById('{{ form.request_type.id_for_label }}').value;
            document.getElementById('student_fields').style.display = requestType === 'student' ? 'block' : 'none';
            document.getElementById('parent_fields').style.display = requestType === 'parent' ? 'block' : 'none';
        }
        document.getElementById('{{ form.request_type.id_for_label }}').addEventListener('change', toggleFields);
        toggleFields();  // Jalankan saat load
    </script>
</div>
{% endblock %}