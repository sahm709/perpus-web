{% extends 'library/base.html' %}

{% block content %}
<h1>Catat Kunjungan ke Perpustakaan</h1>
<p>Silakan isi data kunjungan Anda hari ini. Pilih buku dari katalog atau tulis manual jika belum ada.</p>

{% if form.errors %}
<div class="alert alert-danger">
    <strong>Ada kesalahan:</strong>
    <ul>
        {% for field in form %}
            {% for error in field.errors %}
                <li>{{ field.label }}: {{ error }}</li>
            {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<form method="post">
    {% csrf_token %}
    <div class="mb-3">
        <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
        <input type="text" name="{{ form.name.name }}" class="form-control" id="{{ form.name.id_for_label }}" value="{{ form.name.value|default:'' }}" required>
        {% if form.name.errors %}
            <div class="text-danger">{{ form.name.errors }}</div>
        {% endif %}
    </div>
    <div class="mb-3">
        <label for="{{ form.grade.id_for_label }}" class="form-label">{{ form.grade.label }}</label>
        <input type="text" name="{{ form.grade.name }}" class="form-control" id="{{ form.grade.id_for_label }}" value="{{ form.grade.value|default:'' }}" required>
        {% if form.grade.errors %}
            <div class="text-danger">{{ form.grade.errors }}</div>
        {% endif %}
    </div>
    <div class="mb-3">
        <label for="book-search-input" class="form-label">{{ form.book.label }}</label>
        
        <!-- Hidden input untuk menyimpan nilai pilihan (ID buku), agar kompatibel dengan form Django -->
        <input type="hidden" name="book" id="book-hidden" value="{{ form.book.value }}">
        
        <!-- Input search untuk filter -->
        <input type="text" id="book-search-input" class="form-control" placeholder="Cari buku..." autocomplete="off">
        
        <div style="position: relative;">
            <div id="book-dropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto; width: 100%; position: absolute; z-index: 1000;">
                {% for book in form.book.field.queryset %}
                    <a class="dropdown-item book-option" href="#" data-id="{{ book.id }}" data-title="{{ book.title }}">
                        {{ book.title }}  <!-- Asumsikan field 'title'; ganti jika field berbeda, e.g., book.name -->
                    </a>
                {% empty %}
                    <div class="dropdown-item disabled">Tidak ada buku di katalog.</div>
                {% endfor %}
            </div>
        </div>
        
        {% if form.book.errors %}
            <div class="text-danger">{{ form.book.errors }}</div>
        {% endif %}
    </div>

    <div class="mb-3">
        <label for="{{ form.book_read_manual.id_for_label }}" class="form-label">{{ form.book_read_manual.label }}</label>
        <input type="text" name="{{ form.book_read_manual.name }}" class="form-control" id="{{ form.book_read_manual.id_for_label }}" value="{{ form.book_read_manual.value|default:'' }}">
        <div class="form-text">Tulis judul buku manual jika tidak ada di katalog.</div>
        {% if form.book_read_manual.errors %}
            <div class="text-danger">{{ form.book_read_manual.errors }}</div>
        {% endif %}
    </div>
    <button type="submit" class="btn btn-primary">Catat Kunjungan</button>
    <a href="{% url 'home' %}" class="btn btn-secondary">Batal</a>
</form>

<div class="mt-4">
    <p><strong>Contoh:</strong> Nama: Andi Susanto, Kelas: X IPA 1, Pilih Buku: (dari dropdown) atau Tulis Manual: "Buku Matematika".</p>
</div>
{% endblock %}

<!-- Script dipindah ke sini, dimuat setelah jQuery -->
{% block extra_js %}
<script>
$(document).ready(function() {
    const $searchInput = $('#book-search-input');
    const $dropdown = $('#book-dropdown');
    const $options = $('.book-option');
    const $hiddenInput = $('#book-hidden');
    
    // Toggle dropdown saat klik input
    $searchInput.on('click', function() {
        $dropdown.toggle();
        filterOptions('');  // Tampilkan semua saat buka
    });
    
    // Filter options saat ketik
    $searchInput.on('input', function() {
        const query = $(this).val().toLowerCase();
        filterOptions(query);
        $dropdown.show();  // Pastikan dropdown terbuka saat ketik
    });
    
    // Pilih opsi
    $options.on('click', function(e) {
        e.preventDefault();
        const id = $(this).data('id');
        const title = $(this).data('title');
        $searchInput.val(title);  // Set input ke judul yang dipilih
        $hiddenInput.val(id);     // Set hidden input ke ID
        $dropdown.hide();         // Tutup dropdown
    });
    
    // Klik di luar untuk tutup dropdown
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#book-search-input, #book-dropdown').length) {
            $dropdown.hide();
        }
    });
    
    // Fungsi filter
    function filterOptions(query) {
        $('.temp-no-results').remove();

        let hasResults = false;
        $options.each(function() {
            const title = $(this).data('title').toLowerCase();
            if (title.includes(query)) {
                $(this).show();
                hasResults = true;
            } else {
                $(this).hide();
            }
        });
        // Jika tidak ada hasil, tampilkan pesan
        if (!hasResults && query !== '') {
            $dropdown.append('<div class="dropdown-item disabled temp-no-results">Tidak ada buku ditemukan.</div>');
        }
    }
    
    // Set initial value jika ada (dari form.book.value)
    const initialValue = '{{ form.book.value }}';
    if (initialValue) {
        const $selectedOption = $options.filter(`[data-id="${initialValue}"]`);
        if ($selectedOption.length) {
            $searchInput.val($selectedOption.data('title'));
            $hiddenInput.val(initialValue);
        }
    }
});
</script>
{% endblock %}